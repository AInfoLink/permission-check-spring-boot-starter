name: Apply SQL to Database

on:
  workflow_call:
    inputs:
      apply_to_db:
        description: 'Whether to apply SQL changes to database'
        required: true
        type: boolean
        default: false
      sql_content:
        description: 'SQL content to execute (direct content, not file path)'
        required: true
        type: string
      database_name:
        description: 'Target database name'
        required: false
        type: string
        default: 'booking'
      tenant:
        description: 'Tenant name (optional - for logging purposes)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Perform dry run (validate SQL without executing)'
        required: false
        type: boolean
        default: false
    secrets:
      SSH_HOST:
        required: true
      SSH_USER:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_PORT:
        required: false
      DB_HOST:
        required: true
      DB_USER:
        required: true
      DB_PASSWORD:
        required: true
      DB_PORT:
        required: false

jobs:
  apply-sql:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate inputs
      run: |
        echo "=== SQL Application Configuration ==="
        echo "Apply to DB: ${{ inputs.apply_to_db }}"
        echo "SQL Content Length: $(echo '${{ inputs.sql_content }}' | wc -c) characters"
        echo "Database: ${{ inputs.database_name }}"
        echo "Tenant: ${{ inputs.tenant || 'all tenants' }}"
        echo "Dry Run: ${{ inputs.dry_run }}"
        echo "=================================="
        
        if [ "${{ inputs.apply_to_db }}" = "false" ]; then
          echo "⚠️ SQL application is disabled. Set 'apply_to_db' to true to execute SQL."
        fi

    - name: Apply SQL to database
      if: inputs.apply_to_db == true
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        envs: SQL_CONTENT,DB_HOST,DB_USER,DB_PASSWORD,DB_NAME,DB_PORT,TENANT,DRY_RUN,RUN_NUMBER
        script: |
          set -e
          
          # Setup working directory
          WORK_DIR="/tmp/sql-apply-${RUN_NUMBER:-unknown}"
          mkdir -p $WORK_DIR
          cd $WORK_DIR
          
          echo "=== Starting SQL Application ==="
          echo "Database: ${DB_NAME}"
          echo "Host: ${DB_HOST}"
          echo "Port: ${DB_PORT}"
          echo "User: ${DB_USER}"
          echo "Tenant: ${TENANT}"
          echo "Dry Run: ${DRY_RUN}"
          echo "Working Directory: $WORK_DIR"
          
          # Install PostgreSQL client if not present
          if ! command -v psql &> /dev/null; then
            echo "Installing PostgreSQL client..."
            sudo apt-get update && sudo apt-get install -y postgresql-client
          fi
          
          # Create SQL file from content
          echo "=== Creating SQL File from Content ==="
          printf '%s\n' "${SQL_CONTENT}" > migration.sql
          
          echo "✅ SQL file created: migration.sql"
          echo "File size: $(wc -l < migration.sql) lines"
          
          # Show SQL content for verification
          echo "=== SQL Content Preview ==="
          echo "Complete SQL content:"
          cat migration.sql
          echo "=========================="
          
          # Prepare psql connection
          export PGPASSWORD="${DB_PASSWORD}"
          PSQL_CMD="psql -h ${DB_HOST} -p ${DB_PORT} -U ${DB_USER} -d ${DB_NAME}"
          
          # Test database connection
          echo "=== Testing Database Connection ==="
          if ! $PSQL_CMD -c "SELECT version();" > /dev/null 2>&1; then
            echo "❌ ERROR: Cannot connect to database"
            echo "Connection details:"
            echo "  Host: ${DB_HOST}"
            echo "  Port: ${DB_PORT}"
            echo "  User: ${DB_USER}"
            echo "  Database: ${DB_NAME}"
            exit 1
          fi
          echo "✅ Database connection successful"
          
          # Execute SQL
          if [ "${DRY_RUN}" = "true" ]; then
            echo "=== DRY RUN MODE - Validating SQL ==="
            # Use BEGIN/ROLLBACK for dry run
            echo "BEGIN;" > temp_dry_run.sql
            cat migration.sql >> temp_dry_run.sql
            echo "ROLLBACK;" >> temp_dry_run.sql
            
            echo "Executing SQL in dry-run mode (with ROLLBACK)..."
            $PSQL_CMD \
              --set ON_ERROR_STOP=on \
              --set AUTOCOMMIT=off \
              -f temp_dry_run.sql
            
            echo "✅ DRY RUN SUCCESSFUL - SQL is valid but not applied"
            rm -f temp_dry_run.sql
          else
            echo "=== Applying SQL to Database ==="
            $PSQL_CMD \
              --set ON_ERROR_STOP=on \
              --echo-queries \
              --echo-errors \
              -f migration.sql
            
            echo "✅ SQL APPLIED SUCCESSFULLY"
          fi
          
          # Clean up sensitive data
          unset PGPASSWORD
          
          echo "=== SQL Application Complete ==="
      env:
        SQL_CONTENT: ${{ inputs.sql_content }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_NAME: ${{ inputs.database_name }}
        DB_PORT: ${{ secrets.DB_PORT || 5432 }}
        TENANT: ${{ inputs.tenant }}
        DRY_RUN: ${{ inputs.dry_run }}
        RUN_NUMBER: ${{ github.run_number }}

    - name: Generate SQL application report
      if: always()
      run: |
        echo "## SQL Application Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**Git Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**SQL Content Length:** ${{ inputs.sql_content != '' && 'Provided' || 'Empty' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Database:** ${{ inputs.database_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tenant:** ${{ inputs.tenant || 'all tenants' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ inputs.apply_to_db }}" = "true" ]; then
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "### ✅ SQL Validation Completed (Dry Run)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The SQL file has been validated successfully but **not applied** to the database." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ SQL Applied Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The SQL file has been successfully applied to the database." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### ⚠️ SQL Application Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SQL application was disabled via the \`apply_to_db\` input parameter." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Full execution logs are available in the SSH action output above." >> $GITHUB_STEP_SUMMARY

    - name: Cleanup remote files
      if: always() && inputs.apply_to_db == true
      uses: appleboy/ssh-action@v1
      env:
        RUN_NUMBER: ${{ github.run_number }}
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        envs: RUN_NUMBER
        script: |
          # Clean up temporary files
          rm -rf /tmp/sql-apply-${RUN_NUMBER} || true
          echo "✅ Remote cleanup completed"